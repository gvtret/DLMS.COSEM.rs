name: Rust CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

env:
  CARGO_TERM_COLOR: always

# Общие настройки кэша
defaults:
  run:
    shell: bash

jobs:
  fmt:
    name: Formatting check
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: nightly
        components: rustfmt
    - name: Ensure rustfmt component available
      run: rustup component add --toolchain nightly-x86_64-unknown-linux-gnu rustfmt
    - name: Restore cache
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
    - name: Check formatting
      run: cd dlms-cosem-rs && cargo fmt -- --check

  clippy:
    name: Lint check
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: nightly
        components: clippy
    - name: Ensure clippy component available
      run: rustup component add --toolchain nightly-x86_64-unknown-linux-gnu clippy
    - name: Restore cache
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
    - name: Run Clippy
      run: cd dlms-cosem-rs && cargo clippy -- -D warnings

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [fmt, clippy]
    steps:
    - uses: actions/checkout@v3
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: nightly
    - name: Restore cache
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
    - name: Build
      run: cd dlms-cosem-rs && cargo build --verbose --features std

  test:
    name: Tests
    runs-on: ubuntu-latest
    needs: build
    steps:
    - uses: actions/checkout@v3
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: nightly
    - name: Restore cache
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
    - name: Run tests
      run: cd dlms-cosem-rs && cargo test --verbose --features std

  audit:
    name: Security audit
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: nightly
    - name: Install cargo-audit
      run: cargo install cargo-audit --locked
    - name: Run cargo-audit
      run: cd dlms-cosem-rs && cargo audit --deny warnings

  deny:
    name: Dependency policy check
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: nightly
    - name: Install cargo-deny
      run: cargo install cargo-deny --locked
    - name: Run cargo-deny
      run: cd dlms-cosem-rs && cargo deny check

  docs:
    name: Documentation
    runs-on: ubuntu-latest
    needs: build
    steps:
    - uses: actions/checkout@v3
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: nightly
    - name: Install Doxygen and Graphviz
      run: sudo apt-get update && sudo apt-get install -y doxygen graphviz
    - name: Generate documentation
      run: doxygen docs/Doxyfile
