name: Rust CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

env:
  CARGO_TERM_COLOR: always

# Общие настройки кэша
defaults:
  run:
    shell: bash

jobs:
  setup:
    name: Setup Rust toolchain
    runs-on: ubuntu-latest
    outputs:
      toolchain: ${{ steps.toolchain.outputs.toolchain }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install Rust toolchains
      run: |
        rustup toolchain install stable --profile minimal
        rustup toolchain install nightly --profile minimal
        rustup component add --toolchain stable rustfmt
        rustup component add --toolchain stable clippy
        rustup default stable

    - name: Cache cargo registry and build
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-

  fmt:
    name: Formatting check
    runs-on: ubuntu-latest
    needs: setup
    steps:
    - uses: actions/checkout@v3
    - name: Restore cache
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
    - name: Check formatting
      run: cd dlms-cosem-rs && cargo fmt -- --check

  clippy:
    name: Lint check
    runs-on: ubuntu-latest
    needs: setup
    steps:
    - uses: actions/checkout@v3
    - name: Restore cache
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
    - name: Run Clippy
      run: cd dlms-cosem-rs && cargo clippy -- -D warnings

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [fmt, clippy]
    steps:
    - uses: actions/checkout@v3
    - name: Restore cache
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
    - name: Build
      run: cd dlms-cosem-rs && cargo build --verbose --features std

  test:
    name: Tests
    runs-on: ubuntu-latest
    needs: build
    steps:
    - uses: actions/checkout@v3
    - name: Restore cache
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
    - name: Run tests
      run: cd dlms-cosem-rs && cargo test --verbose --features std

  audit:
    name: Security audit
    runs-on: ubuntu-latest
    needs: setup
    steps:
    - uses: actions/checkout@v3
    - name: Install cargo-audit
      run: cargo install cargo-audit --locked
    - name: Run cargo-audit
      run: cd dlms-cosem-rs && cargo audit --deny warnings

  deny:
    name: Dependency policy check
    runs-on: ubuntu-latest
    needs: setup
    steps:
    - uses: actions/checkout@v3
    - name: Install cargo-deny
      run: cargo install cargo-deny --locked
    - name: Run cargo-deny
      run: cd dlms-cosem-rs && cargo deny check
